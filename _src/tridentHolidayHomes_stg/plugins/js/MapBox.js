let selfMap,popup,customLocationFlag=!0,lastClickMarkerLong=0,lastClickMarkerLat=0,heightDivCanvas,divMapaAlojamientos,divMapBar;function MapBox(e,t){Maps.call(this,e,t),this.maxZoom=this.data.zoom_limit,this.urlRewriteOnline=window.location.hostname,this.markerType,this.markerPath,this.favMarkerPath,this.clusterMarkerPath,this.multiHouseMarkerPath,this.mapResultsVersion,this.script=document.createElement("script"),this.script2=document.createElement("script"),this.setParametersMap()}document.getElementById("mapa-alojamientos")&&(heightDivCanvas=document.getElementById("mapa-alojamientos").clientHeight,divMapaAlojamientos=document.getElementById("mapa-alojamientos"),divMapBar=document.querySelector(".map-bar")),MapBox.prototype=Object.create(Maps.prototype),MapBox.prototype.setParametersMap=function(){document.getElementById("zoomMap")&&document.getElementById("coordinatesClient")&&(this.zoom=document.getElementById("zoomMap").value,this.coordinates=JSON.parse(document.getElementById("coordinatesClient").value))},MapBox.prototype.setUrlIcons=function(){this.markerType=this.data.markerType,this.markerPath=this.data.marker,this.favMarkerPath=this.data.favmarker,this.clusterMarkerPath=this.data.clustermarker,this.multiHouseMarkerPath=this.data.multihousemarker,this.mapResultsVersion=this.data.mapResultsVersion},MapBox.prototype.checkIsDev=function(){return!!~this.urlRewriteOnline.indexOf(".local")},MapBox.prototype.loadMap=function(){selfMap=this,selfMap.setUrlIcons(),selfMap.initMap(),selfMap.addImages(),map.on("load",function(){selfMap.addMarkers(),selfMap.addEventsMarkers(),document.getElementById("loading-map").style.display="none"})},MapBox.prototype.getAccessToken=function(){return document.getElementById("api-key-mapbox").value},MapBox.prototype.initMap=function(){mapboxgl.accessToken=this.getAccessToken(),this.coordinates||(this.coordinates={lat:53.7798,lng:-7.3055},customLocationFlag=!1),this.zoom||(this.zoom=6),map=new mapboxgl.Map({container:"map_canvas",style:this.data.mapStyle,center:[this.coordinates.lng,this.coordinates.lat],maxZoom:17,minZoom:2,zoom:this.zoom,scrollZoom:!1,dragPan:!1,attributionControl:!0}),1==document.getElementById("map-style-type").value&&map.setStyle("mapbox://styles/mapbox/satellite-streets-v10"),map.addControl(new mapboxgl.NavigationControl,"bottom-right"),selfMap.createSpiderifier()},MapBox.prototype.createSpiderifier=function(){2==this.mapResultsVersion&&0==this.markerType&&(spiderifier=new MapboxglSpiderifier(map,{animate:!0,animationSpeed:200,customPin:!0,initializeLeg:this.initializeSpiderLeg,circleSpiralSwitchover:15,circleFootSeparation:90,spiralFootSeparation:30})),2==this.mapResultsVersion&&0==this.markerType||(spiderifier=new MapboxglSpiderifier(map,{animate:!0,animationSpeed:200,customPin:!0,initializeLeg:this.initializeSpiderLeg,circleSpiralSwitchover:30,circleFootSeparation:34,spiralFootSeparation:36}))},MapBox.prototype.initializeSpiderLeg=function(e){let t=e.elements.pin,o=e.feature;t.innerHTML='<img loading="lazy" alt="'+accommodation.nombre+'" data-src="'+selfMap.markerPath+'" src="'+selfMap.markerPath+'">',jQuery(t).on("click",function(){void 0!==popup&&popup.remove(),selfMap.getAccommodationData(o,function(t){let o=selfMap.getInfoWindow(t);(popup=new mapboxgl.Popup({closeButton:!0,closeOnClick:!1,offset:MapboxglSpiderifier.popupOffsetForSpiderLeg(e)})).setHTML(o).addTo(map),offset=-125,1==multiphoto&&(offset=-200),e.mapboxMarker.setPopup(popup),map.panTo(popup.getLngLat(),{offset:[0,offset]}),selfMap.setStyles()})})},MapBox.prototype.openMultiHousePopUp=function(e){map.getSource("locations").getClusterChildren(e.cluster_id,function(e,t){let o=[t[0].geometry.coordinates[0],t[0].geometry.coordinates[1]],a=[];t.forEach(function(e){a.push(e.properties)}),selfMap.getAccommodationMultiHouseData(a,function(e,t){let a=selfMap.getInfoWindow(e);if(4===t){let i=(popup=new mapboxgl.Popup().setLngLat(o).setHTML('<div id="multiHouseContainer"></div>').addTo(map)).getLngLat();map.panTo(i,{offset:[0,-125]}),selfMap.setStyles()}document.getElementById("multiHouseContainer").insertAdjacentHTML("beforeend",a)})})},MapBox.prototype.multiHousePopUp=function(e){selfMap.openMultiHousePopUp(e.features[0].properties)},MapBox.prototype.filterDataLocations=function(e){let t={type:"FeaturedCollection",features:[]};return t.features=e.map(function(e){return{type:"Feature",properties:e,geometry:{type:"Point",coordinates:[e.longitud,e.latitud]}}}),t},MapBox.prototype.addImages=function(){map.loadImage(this.clusterMarkerPath,function(e,t){if(e)throw e;map.addImage("clusterMarkerPath",t)}),map.loadImage(this.markerPath,function(e,t){if(e)throw e;map.addImage("markerPath",t)}),map.loadImage(this.favMarkerPath,function(e,t){if(e)throw e;map.addImage("favMarkerPath",t)}),map.loadImage(this.multiHouseMarkerPath,function(e,t){if(e)throw e;map.addImage("multiHouseMarkerPath",t)})},MapBox.prototype.addMarkers=function(){let e=this.filterDataLocations(this.data.locations);if(map.addSource("locations",{type:"geojson",data:e,cluster:!0,clusterMaxZoom:20,clusterRadius:40}),selfMap.addMarkersToMapbox(),!customLocationFlag){let t=new mapboxgl.LngLatBounds;e.features.forEach(function(e){t.extend(e.geometry.coordinates)}),map.fitBounds(t,{padding:100})}},MapBox.prototype.addMarkersToMapbox=function(){let e="#ffffff",t=[0,-1.9];1==this.markerType&&(e="#007072"),2==this.markerType&&(t=[0,-2]),3==this.markerType&&(e="#007072",t=[.1,-2.3]),2==this.mapResultsVersion&&0==this.markerType&&(e="#007072",t=[0,-.1]),2==this.mapResultsVersion&&0==this.markerType&&(map.addLayer({id:"markers",type:"circle",source:"locations",filter:["!has","point_count"],paint:{"circle-radius":{base:1.75,stops:[[12,18],[18,120]]},"circle-color":"rgba(0, 114, 115, 0.4)"}}),map.addLayer({id:"cluster",type:"circle",source:"locations",filter:["has","point_count"],maxzoom:20,paint:{"circle-radius":{base:1.75,stops:[[12,25],[18,85]]},"circle-color":"rgba(0, 114, 115, 0.4)"}}),map.addLayer({id:"cluster-count",type:"symbol",source:"locations",filter:["has","point_count"],maxzoom:20,layout:{"text-field":"{point_count_abbreviated}","text-font":["DIN Offc Pro Medium","Arial Unicode MS Bold"],"text-size":12}}),map.addLayer({id:"multiHouseMarker",type:"circle",source:"locations",filter:["has","point_count"],minzoom:16,maxzoom:20,paint:{"circle-radius":{base:1.75,stops:[[12,25],[18,85]]},"circle-color":"rgba(155, 155, 155, 0)"}})),2==this.mapResultsVersion&&0==this.markerType||(map.addLayer({id:"markers",type:"symbol",source:"locations",filter:["!has","point_count"],layout:{"icon-image":"markerPath","icon-size":1,"icon-ignore-placement":!0,"icon-offset":[0,-20]}}),map.addLayer({id:"cluster",type:"symbol",source:"locations",filter:["has","point_count"],maxzoom:17,layout:{"text-field":"{point_count}","text-size":13,"text-font":["Arial Unicode MS Bold"],"text-offset":t,"icon-image":"clusterMarkerPath","icon-size":1,"icon-ignore-placement":!0,"icon-offset":[0,-20]},paint:{"text-color":e}}),map.addLayer({id:"multiHouseMarker",type:"symbol",source:"locations",filter:["has","point_count"],minzoom:17,maxzoom:20,layout:{"icon-image":"multiHouseMarkerPath","icon-size":1,"icon-ignore-placement":!0}}),map.addLayer({id:"favMarker",type:"symbol",source:"locations",filter:["==","favorito",!0],layout:{"icon-image":"favMarkerPath","icon-size":1,"icon-ignore-placement":!0,"icon-offset":[0,-20]}}))},MapBox.prototype.clusterEvent=function(e){let t=map.queryRenderedFeatures(e.point,{layers:["cluster"]}),o=t[0].properties.cluster_id;map.getSource("locations").getClusterExpansionZoom(o,function(e,o){!e&&map.easeTo({center:t[0].geometry.coordinates,zoom:o})})},MapBox.prototype.mouseMove=function(e){map.queryRenderedFeatures(e.point,{layers:["multiHouseMarker"]})},MapBox.prototype.openPopUp=function(e){this.getAccommodationData(e,function(e){let t=[e.longitud,e.latitud],o=selfMap.getInfoWindow(e),a={},i=-125;void 0!==popup&&popup.remove(),1==multiphoto&&(a.className="container-multiphoto",i=-200);let r=(popup=new mapboxgl.Popup(a).setLngLat(t).setHTML(o).addTo(map)).getLngLat();map.panTo(r,{offset:[0,i]}),selfMap.setStyles()})},MapBox.prototype.zoomOnClickMarker=function(e){13>map.getZoom()&&lastClickMarkerLong!=e.longitud&&lastClickMarkerLat!=e.latitud&&map.flyTo({center:[e.longitud,e.latitud],zoom:13,speed:2,curve:1,easing:e=>e}),lastClickMarkerLong=e.longitud,lastClickMarkerLat=e.latitud},MapBox.prototype.addEventsMarkers=function(){map.on("click",function(e){map.scrollZoom.enable(),"results"===selfMap.type&&addFavoritosResultados(idFavorito),void 0!==popup&&popup.remove(),selfMap.resizeMapControl()}),map.on("zoomstart",function(){spiderifier.unspiderfy()}),map.on("mousemove",function(e){map.dragPan.enable()}),map.on("mouseout",function(e){map.dragPan.disable(),map.scrollZoom.disable()}),map.on("mousemove",this.mouseMove),map.on("click","multiHouseMarker",function(e){return selfMap.multiHousePopUp(e)}),map.on("click","cluster",this.clusterEvent),map.on("click","markers",function(e){selfMap.zoomOnClickMarker(e.features[0].properties),selfMap.openPopUp(e.features[0].properties)}),mouseover&&modeResort&&(map.on("mouseover","markers",function(e){selfMap.openPopUp(e.features[0].properties)}),map.on("mouseover","multiHouseMarker",function(e){return selfMap.multiHousePopUp(e)})),map.on("mouseenter","markers",function(){map.getCanvas().style.cursor="pointer"}),map.on("mouseleave","markers",function(){map.getCanvas().style.cursor=""}),map.on("mouseenter","cluster",function(){map.getCanvas().style.cursor="pointer"}),map.on("mouseleave","cluster",function(){map.getCanvas().style.cursor=""}),map.on("mouseenter","multiHouseMarker",function(){map.getCanvas().style.cursor="pointer"}),map.on("mouseleave","multiHouseMarker",function(){map.getCanvas().style.cursor=""})},MapBox.prototype.resizeMapControl=function(){document.getElementById("button-fullscreen-map")&&selfMap.isMobile()&&(document.getElementById("button-fullscreen-map").addEventListener("click",selfMap.controlButtonMap),divMapaAlojamientos.addEventListener("click",selfMap.fullScreenMap)),jQuery(window).resize(function(){if(document.querySelector("#mapa-alojamientos canvas").style.height=heightDivCanvas+"px",map.resize(),selfMap.isMobile()){document.getElementById("button-fullscreen-map").addEventListener("click",selfMap.controlButtonMap),divMapaAlojamientos.addEventListener("click",selfMap.fullScreenMap);return}selfMap.isMobile()||(document.getElementById("button-fullscreen-map").removeEventListener("click",selfMap.controlButtonMap),divMapaAlojamientos.removeEventListener("click",selfMap.fullScreenMap),divMapBar.classList.remove("on"),divMapBar.style.display="none",map.resize())})},MapBox.prototype.controlButtonMap=function(){document.querySelector("#mapa-alojamientos canvas").style.height=heightDivCanvas+"px",divMapBar.classList.remove("on"),divMapBar.style.display="none",divMapaAlojamientos.classList.remove("map-fullscreen"),document.querySelector("#map_canvas").style.height="100%",map.resize(),event.stopPropagation()},MapBox.prototype.fullScreenMap=function(){document.querySelector("#mapa-alojamientos canvas").style.height=heightDivCanvas+"px",divMapBar.style.display="block",document.querySelector("#map_canvas").style.height="100vh",divMapaAlojamientos.classList.add("map-fullscreen"),map.resize(),setTimeout(()=>{map.resize(),divMapBar.classList.add("on")},250)},MapBox.prototype.isMobile=function(){return!!(window.innerWidth<=425)&&"iPhone"!=navigator.platform&&"iPad"!=navigator.platform};